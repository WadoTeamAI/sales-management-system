{% extends "base.html" %}

{% block title %}分析 - 営業管理システム{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-graph-up"></i> 売上分析</h1>
    <div>
        <button class="btn btn-outline-secondary" onclick="refreshAnalytics()">
            <i class="bi bi-arrow-clockwise"></i> 更新
        </button>
        <button class="btn btn-success" onclick="exportReport()">
            <i class="bi bi-download"></i> レポート出力
        </button>
    </div>
</div>

<div class="row mb-4">
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-pie-chart"></i> 目標達成状況</h5>
            </div>
            <div class="card-body">
                <canvas id="achievementChart" height="200"></canvas>
                <div id="achievementSummary" class="mt-3">
                    <div class="text-center text-muted py-3">
                        <i class="bi bi-arrow-clockwise spin"></i>
                        データを読み込み中...
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-graph-up-arrow"></i> 売上推移</h5>
            </div>
            <div class="card-body">
                <canvas id="salesTrendChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-lightbulb"></i> 分析インサイト</h5>
            </div>
            <div class="card-body">
                <div id="insights">
                    <div class="text-center text-muted py-3">
                        <i class="bi bi-arrow-clockwise spin"></i>
                        分析処理中...
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-list-check"></i> 推奨アクション</h5>
            </div>
            <div class="card-body">
                <div id="recommendations">
                    <div class="text-center text-muted py-3">
                        推奨事項を分析中...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let achievementChart, salesTrendChart;

function loadAnalytics() {
    fetch('/api/analytics')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Error:', data.error);
                return;
            }
            
            updateAchievementChart(data.gap_analysis || {});
            updateSalesTrendChart();
            updateInsights(data.gap_analysis?.insights || []);
            updateRecommendations(data.gap_analysis?.recommendations || []);
        })
        .catch(error => {
            console.error('Error loading analytics:', error);
        });
}

function updateAchievementChart(gapAnalysis) {
    const ctx = document.getElementById('achievementChart').getContext('2d');
    
    if (achievementChart) {
        achievementChart.destroy();
    }
    
    // サンプルデータ
    achievementChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['達成', '順調', '遅れ気味', '要注意'],
            datasets: [{
                data: [1, 0, 0, 1],
                backgroundColor: [
                    '#28a745',
                    '#17a2b8', 
                    '#ffc107',
                    '#dc3545'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function updateSalesTrendChart() {
    const ctx = document.getElementById('salesTrendChart').getContext('2d');
    
    if (salesTrendChart) {
        salesTrendChart.destroy();
    }
    
    // サンプル月次売上データ
    const months = ['1月', '2月', '3月', '4月', '5月', '6月'];
    const salesData = [800000, 950000, 1200000, 1100000, 1300000, 1150000];
    const targetData = [1000000, 1000000, 1000000, 1000000, 1000000, 1000000];
    
    salesTrendChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: months,
            datasets: [{
                label: '実績',
                data: salesData,
                borderColor: '#0d6efd',
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                tension: 0.4
            }, {
                label: '目標',
                data: targetData,
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                borderDash: [5, 5],
                tension: 0
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '¥' + value.toLocaleString();
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function updateInsights(insights) {
    const insightsEl = document.getElementById('insights');
    
    if (insights.length === 0) {
        insightsEl.innerHTML = `
            <div class="text-center text-muted py-3">
                <i class="bi bi-info-circle"></i>
                現在特別な分析結果はありません
            </div>
        `;
        return;
    }
    
    let html = '';
    insights.forEach((insight, index) => {
        html += `
            <div class="alert alert-info alert-sm">
                <i class="bi bi-lightbulb"></i>
                <strong>インサイト ${index + 1}:</strong> ${insight}
            </div>
        `;
    });
    
    insightsEl.innerHTML = html;
}

function updateRecommendations(recommendations) {
    const recommendationsEl = document.getElementById('recommendations');
    
    if (recommendations.length === 0) {
        recommendationsEl.innerHTML = `
            <div class="text-center text-muted py-3">
                <i class="bi bi-check-circle"></i>
                現在推奨アクションはありません
            </div>
        `;
        return;
    }
    
    let html = '<ul class="list-unstyled">';
    recommendations.forEach(recommendation => {
        html += `
            <li class="mb-2">
                <i class="bi bi-arrow-right text-primary"></i>
                ${recommendation}
            </li>
        `;
    });
    html += '</ul>';
    
    recommendationsEl.innerHTML = html;
}

function refreshAnalytics() {
    loadAnalytics();
}

function exportReport() {
    alert('レポート出力機能は開発中です');
}

document.addEventListener('DOMContentLoaded', function() {
    loadAnalytics();
});
</script>
{% endblock %}
